# ğŸš€ ENDPOINTS DESPLEGADOS - NOTIFICACIONES DE ESTADO

Fecha: 16 de noviembre de 2024
Stage: dev
Region: us-east-1

## ğŸ“¡ REST API
BASE_URL: https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev

### AutenticaciÃ³n
POST   /auth/register        - Registrar nuevo usuario
POST   /auth/login           - Iniciar sesiÃ³n
GET    /users                - Listar usuarios (admin only)

### Incidentes
POST   /incidentes           - Crear incidente (estudiante) â†’ estado: "pendiente"
GET    /incidentes           - Listar incidentes (filtrado por rol)
PUT    /incidentes/{id}      - Editar incidente (admin)
PUT    /incidentes/{id}/asignar - Asignar a trabajador (admin) â†’ estado: "en atenciÃ³n" + NOTIFICACIÃ“N
PUT    /incidentes/{id}/completar - Completar incidente (trabajador/admin) â†’ estado: "completado" + NOTIFICACIÃ“N

## ğŸ”Œ WebSocket API
WS_URL: wss://6qtk3h60si.execute-api.us-east-1.amazonaws.com/dev

ConexiÃ³n: wss://6qtk3h60si.execute-api.us-east-1.amazonaws.com/dev?email={USER_EMAIL}

### Mensajes que recibirÃ¡s:
1. action: "estado_change" - Cuando cambia el estado de tu incidente
2. action: "new_incidente" - Cuando se crea un nuevo incidente (broadcast)

## ğŸ”” FLUJO DE NOTIFICACIONES

### Caso 1: Estudiante crea incidente
1. Estudiante: POST /incidentes
   â†’ Estado: "pendiente"
   â†’ NO se envÃ­a notificaciÃ³n (es el creador)

### Caso 2: Admin asigna incidente a trabajador
1. Admin: PUT /incidentes/{id}/asignar
   â†’ Estado: "pendiente" â†’ "en atenciÃ³n"
   â†’ âœ… NOTIFICACIÃ“N enviada al estudiante creador

### Caso 3: Trabajador completa el incidente
1. Trabajador: PUT /incidentes/{id}/completar
   â†’ Estado: "en atenciÃ³n" â†’ "completado"
   â†’ âœ… NOTIFICACIÃ“N enviada al estudiante creador

### Caso 4: Admin cambia estado manualmente
1. Admin: PUT /incidentes/{id} (con "estado" en body)
   â†’ Estado: cualquier cambio
   â†’ âœ… NOTIFICACIÃ“N enviada al estudiante creador

## ğŸ“ HEADERS REQUERIDOS
Todos los endpoints REST requieren:
X-User-Email: {email-del-usuario}

## ğŸ§ª PRUEBA RÃPIDA

### 1. Registrar usuarios
# Admin
curl -X POST https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@test.com",
    "password": "admin123",
    "nombre": "Admin Test",
    "tipo": "admin"
  }'

# Estudiante
curl -X POST https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "estudiante@test.com",
    "password": "est123",
    "nombre": "Estudiante Test",
    "tipo": "estudiante"
  }'

# Trabajador
curl -X POST https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "trabajador@test.com",
    "password": "trab123",
    "nombre": "Trabajador Test",
    "tipo": "trabajador",
    "especialidad": "PlomerÃ­a"
  }'

### 2. Estudiante crea incidente
curl -X POST https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev/incidentes \
  -H "Content-Type: application/json" \
  -H "X-User-Email: estudiante@test.com" \
  -d '{
    "titulo": "Fuga de agua en baÃ±o",
    "descripcion": "Hay una fuga importante",
    "tipo": "PlomerÃ­a",
    "piso": "2",
    "lugar_especifico": "BaÃ±o principal"
  }'
# Respuesta: guardas el "id" del incidente

### 3. Estudiante se conecta al WebSocket (navegador)
const ws = new WebSocket('wss://6qtk3h60si.execute-api.us-east-1.amazonaws.com/dev?email=estudiante@test.com');
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('ğŸ”” NotificaciÃ³n:', data);
};

### 4. Admin asigna el incidente (trigger notificaciÃ³n)
curl -X PUT https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev/incidentes/{INCIDENT_ID}/asignar \
  -H "Content-Type: application/json" \
  -H "X-User-Email: admin@test.com" \
  -d '{
    "trabajador_email": "trabajador@test.com"
  }'
# â†’ El estudiante recibe notificaciÃ³n: "pendiente" â†’ "en atenciÃ³n"

### 5. Trabajador completa el incidente (trigger notificaciÃ³n)
curl -X PUT https://pj9trlx4uf.execute-api.us-east-1.amazonaws.com/dev/incidentes/{INCIDENT_ID}/completar \
  -H "X-User-Email: trabajador@test.com"
# â†’ El estudiante recibe notificaciÃ³n: "en atenciÃ³n" â†’ "completado"

## ğŸ¯ FORMATO DE NOTIFICACIÃ“N RECIBIDA

{
  "action": "estado_change",
  "incidente_id": "uuid-del-incidente",
  "titulo": "Fuga de agua en baÃ±o",
  "old_estado": "pendiente",
  "new_estado": "en atenciÃ³n",
  "timestamp": "2024-11-16T12:34:56.789Z",
  "mensaje": "Tu incidente 'Fuga de agua en baÃ±o' cambiÃ³ de estado: pendiente â†’ en atenciÃ³n"
}

## âœ… VERIFICACIÃ“N
- [ ] Usuarios registrados correctamente
- [ ] Incidente creado con estado "pendiente"
- [ ] WebSocket conectado con email de estudiante
- [ ] NotificaciÃ³n recibida al asignar
- [ ] NotificaciÃ³n recibida al completar

## ğŸ› DEBUG
Ver logs de Lambda:
serverless logs -f api --tail
serverless logs -f wsConnect --tail

## ğŸ“š DOCUMENTACIÃ“N
- ESTADO_NOTIFICATIONS.md - ExplicaciÃ³n detallada del sistema
- frontend/notification-manager.js - Cliente WebSocket completo
